"use strict";var _cateLabel,_cateAssetsCount,_currentItemIndex;function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable});keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(source,true).forEach(function(key){_defineProperty(target,key,source[key])})}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source))}else{ownKeys(source).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))})}}return target}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}var categoryEnum={frame:"frame",base:"base",face:"facial-expression",goggles:"goggles",hair:"hair",helmet:"helmet",mask:"mask",weapon:"weapon",words:"words"};var categoriesInOrder=[categoryEnum.base,categoryEnum.face,categoryEnum.hair,categoryEnum.helmet,categoryEnum.mask,categoryEnum.goggles,categoryEnum.weapon,categoryEnum.words,categoryEnum.frame];var cateoriesNotInControl=[categoryEnum.frame];var cateLabel=(_cateLabel={},_defineProperty(_cateLabel,categoryEnum.base,"\u5834\u666F"),_defineProperty(_cateLabel,categoryEnum.face,"\u9762\u5BB9"),_defineProperty(_cateLabel,categoryEnum.hair,"\u982D\u9AEE"),_defineProperty(_cateLabel,categoryEnum.helmet,"\u982D\u76D4"),_defineProperty(_cateLabel,categoryEnum.mask,"\u9762\u7F69"),_defineProperty(_cateLabel,categoryEnum.goggles,"\u773C\u93E1"),_defineProperty(_cateLabel,categoryEnum.weapon,"\u914D\u4EF6"),_defineProperty(_cateLabel,categoryEnum.words,"\u6587\u5B57"),_cateLabel);var cateAssetsCount=(_cateAssetsCount={},_defineProperty(_cateAssetsCount,categoryEnum.base,6),_defineProperty(_cateAssetsCount,categoryEnum.face,8),_defineProperty(_cateAssetsCount,categoryEnum.hair,10),_defineProperty(_cateAssetsCount,categoryEnum.helmet,4),_defineProperty(_cateAssetsCount,categoryEnum.mask,5),_defineProperty(_cateAssetsCount,categoryEnum.goggles,5),_defineProperty(_cateAssetsCount,categoryEnum.weapon,8),_defineProperty(_cateAssetsCount,categoryEnum.words,7),_defineProperty(_cateAssetsCount,categoryEnum.frame,1),_cateAssetsCount);var assetsOrigin="";var assetsPath="assets";var assetsType={icons:"icons",preview:"preview",output:"output"};var pixiOptions={backgroundColor:16448250,preserveDrawingBuffer:false,antialias:true};var state={currentCategoryIndex:0,currentItemIndex:(_currentItemIndex={},_defineProperty(_currentItemIndex,categoryEnum.base,0),_defineProperty(_currentItemIndex,categoryEnum.face,0),_defineProperty(_currentItemIndex,categoryEnum.hair,0),_defineProperty(_currentItemIndex,categoryEnum.helmet,0),_defineProperty(_currentItemIndex,categoryEnum.mask,0),_defineProperty(_currentItemIndex,categoryEnum.goggles,0),_defineProperty(_currentItemIndex,categoryEnum.weapon,0),_defineProperty(_currentItemIndex,categoryEnum.words,0),_defineProperty(_currentItemIndex,categoryEnum.frame,1),_currentItemIndex),previewSize:500};function getImageSrc(category,type,index){return"".concat(assetsOrigin).concat(assetsPath,"/").concat(type,"/").concat(category,"/").concat(_.padStart(index.toString(),2,"0"),".png")}function onImageLoaded(url,cb){var image=new Image;image.src=url;if(image.complete){cb(image)}else{image.onload=function(){cb(image)}}}$(document).ready(function(){var hdSize=2048;function downloadCanvasAsPNG(hdPixiApp,filename,$container){try{var canvas=hdPixiApp.renderer.extract.canvas(hdPixiApp.stage);var $image=$("<img />");var imageDataURL=canvas.toDataURL("image/png");hdPixiApp.destroy();var $link=$("<a download=\"".concat(filename,"\">\u9EDE\u6B64\u9023\u7D50\u4E0B\u8F09</a>"));$link.attr("href",imageDataURL);$image.attr("src",imageDataURL);$container.empty();$container.append($("<div>\u2193\u96FB\u8166\u53F3\u9375\u6216\u624B\u6A5F\u9577\u58D3\u53E6\u5B58\u5716\u7247\u2193</div>"),$image,$("<br />"),"\u82E5\u60A8\u7684\u88DD\u7F6E\u7121\u6CD5\u5B58\u5716\uFF0C\u53EF",$link);try{sendDownloadEventToGtag();_.forEach(state.currentItemIndex,function(value,categoryEnum){sendPickItemEventToGtag(categoryEnum,value)})}catch(gtagError){}}catch(error){console.error(error);if(typeof window.alert==="function"){window.alert("\u8A18\u61B6\u9AD4\u4E0D\u8DB3\u6216\u700F\u89BD\u5668\u932F\u8AA4")}}}function createHDimage(){$("#loader").removeClass("hide");var hdPixiApp=new PIXI.Application(_objectSpread({},pixiOptions,{width:hdSize,height:hdSize}));var loadImageTasks=[];categoriesInOrder.forEach(function(categoryEnum){var itemIndex=state.currentItemIndex[categoryEnum];if(itemIndex>0){var container=new PIXI.Container;var src=getImageSrc(categoryEnum,assetsType.output,itemIndex);loadImageTasks.push(new Promise(function(resolve){onImageLoaded(src,function(image){var sprite=PIXI.Sprite.from(image);sprite.width=2048;sprite.height=2048;container.removeChildren();container.addChild(sprite);resolve()})}));hdPixiApp.stage.addChild(container)}});return Promise.all(loadImageTasks).then(function(){return hdPixiApp})}function sendPickItemEventToGtag(categoryEnum,value){return gtag("event","Pick Support HK Item",{event_category:"Pick Support HK Item",event_label:cateLabel[categoryEnum],value:value})}function sendDownloadEventToGtag(){return gtag("event","Download Support HK Avatar",{event_category:"Download Support HK Avatar"})}function handleResize(){try{var viewportWidth=Math.max(document.documentElement.clientWidth,window.innerWidth||0);var nextPreviewSize=viewportWidth*0.9>500?500:viewportWidth*0.9;setState({previewSize:nextPreviewSize})}catch(err){console.error("Error on resizing:",err)}}handleResize();function setState(){var stateToMerge=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var forceUpdate=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var nextCategoryIndex=_.get(stateToMerge,"currentCategoryIndex");if(typeof nextCategoryIndex==="number"&&(nextCategoryIndex!==state.currentCategoryIndex||forceUpdate)){var nextCategory=categoriesInOrder[nextCategoryIndex];controls.focusCategory(nextCategoryIndex);controls.reRenderItems(nextCategoryIndex);controls.focusItem(state.currentItemIndex[nextCategory])}var itemsToUpdate=_.get(stateToMerge,["currentItemIndex"]);_.forEach(itemsToUpdate,function(nextItemIndex,itemCategory){var currentCategory=categoriesInOrder[state.currentCategoryIndex];if(typeof nextItemIndex==="number"&&(nextItemIndex!==state.currentItemIndex[itemCategory]||forceUpdate)){if(currentCategory===itemCategory){controls.focusItem(nextItemIndex)}preview.updateItem(_.findIndex(categoriesInOrder,function(cat){return cat===itemCategory}),nextItemIndex)}});_.merge(state,stateToMerge)}var controls={focusCategory:function focusCategory(targetCategoryIndex){$("#cate-".concat(categoriesInOrder[state.currentCategoryIndex])).removeClass("focus");$("#cate-".concat(categoriesInOrder[targetCategoryIndex])).addClass("focus")},focusItem:function focusItem(targetItemIndex){var currentCategory=categoriesInOrder[state.currentCategoryIndex];$("#item-".concat(state.currentItemIndex[currentCategory])).removeClass("focus");$("#item-".concat(targetItemIndex)).addClass("focus")},reRenderItems:function reRenderItems(targetCategoryIndex){$("#items").empty();var targetCategory=categoriesInOrder[targetCategoryIndex];var assetsCount=cateAssetsCount[targetCategory];var $emptyItem=$("<div class=\"item\" id=\"item-0\"></div>");var $items=[$emptyItem];for(var i=1;i<=assetsCount;i+=1){var src=getImageSrc(targetCategory,assetsType.icons,i);var $item=$("<div class=\"item\" id=\"item-".concat(i,"\"><img src=").concat(src," /></div>"));$items.push($item)}$items.forEach(function($item,i){$item.click(function(){setState({currentItemIndex:_defineProperty({},targetCategory,i)})})});$("#items").append($emptyItem,$items)}};var preview={updateItem:function updateItem(targetCategoryIndex,targetItemIndex){var targetCategory=categoriesInOrder[targetCategoryIndex];var container=containers[targetCategory];if(targetItemIndex>0){var src=getImageSrc(targetCategory,assetsType.preview,targetItemIndex);onImageLoaded(src,function(image){var sprite=PIXI.Sprite.from(image);sprite.width=state.previewSize;sprite.height=state.previewSize;container.removeChildren();container.addChild(sprite)})}else{container.removeChildren()}}};function handleNext(){var targetIndex=state.currentCategoryIndex===categoriesInOrder.length-1?0:state.currentCategoryIndex+1;setState({currentCategoryIndex:targetIndex})}function handlePrev(){var targetIndex=state.currentCategoryIndex>0?state.currentCategoryIndex-1:categoriesInOrder.length-1;setState({currentCategoryIndex:targetIndex})}var pixiApp=new PIXI.Application(_objectSpread({},pixiOptions,{width:state.previewSize,height:state.previewSize}));var containers={};categoriesInOrder.forEach(function(categoryEnum){containers[categoryEnum]=new PIXI.Container;pixiApp.stage.addChild(containers[categoryEnum])});$("#preview").append(pixiApp.view);categoriesInOrder.forEach(function(category,i){if(_.includes(cateoriesNotInControl,category)){return}var $category=$("<div id=\"cate-".concat(category,"\" class=\"category\">").concat(cateLabel[category],"</div>"));$("#categories").append($category);$category.click(function(){setState({currentCategoryIndex:i})})});setState({currentCategoryIndex:state.currentCategoryIndex,currentItemIndex:state.currentItemIndex},true);$("#prev-category").click(handlePrev);$("#next-category").click(handleNext);$("#create-avatar").click(function(){createHDimage().then(function(hdPixiApp){$("#loader").addClass("hide");downloadCanvasAsPNG(hdPixiApp,"i-support-hk.png",$("#download-avatar"))})})});